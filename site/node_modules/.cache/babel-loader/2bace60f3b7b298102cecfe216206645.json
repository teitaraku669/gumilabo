{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.verifyConfig = exports.handleUseApiOptions = exports.fetchApi = exports.reducer = exports.useApi = void 0;\n\nvar react_1 = require(\"react\");\n\nvar context_1 = require(\"./context\");\n\nvar common_1 = require(\"./common\");\n\nfunction useApi(config, opt) {\n  var _this = this;\n\n  if (typeof config === 'string') {\n    config = {\n      url: config\n    };\n  }\n\n  var context = react_1.useContext(context_1.ApiContext);\n  var settings = context.settings,\n      _a = context.settings,\n      cache = _a.cache,\n      debug = _a.debug,\n      clearLastCacheWhenConfigChanges = _a.clearLastCacheWhenConfigChanges,\n      isSSR = context.isSSR,\n      _b = context.collection,\n      ssrConfigs = _b.ssrConfigs,\n      cacheKeys = _b.cacheKeys;\n  var cacheKey = JSON.stringify(config);\n  var ref = react_1.useRef(react_1.useMemo(function () {\n    return {\n      id: Date.now(),\n      isRequesting: false,\n      isInit: false,\n      hasFed: false,\n      refreshFlag: 1,\n      cacheKey: cacheKey,\n      config: config\n    };\n  }, []));\n  var options = react_1.useMemo(function () {\n    return exports.handleUseApiOptions(opt, settings, config, cacheKey);\n  }, [opt, settings, cacheKey]);\n  var refData = ref.current;\n  var isValidConfig = exports.verifyConfig(config);\n  var hasChangedConfig = refData.cacheKey !== cacheKey;\n  options.$hasChangedConfig = hasChangedConfig;\n\n  if (hasChangedConfig) {\n    if (clearLastCacheWhenConfigChanges) {\n      cache.del(refData.cacheKey);\n    }\n\n    refData.cacheKey = cacheKey;\n    refData.config = config;\n    refData.hasFed = false;\n  } // SSR processing\n\n\n  var cacheData = cache.get(cacheKey);\n  var skip = options.skip,\n      useCache = options.useCache;\n\n  var defaultState = __assign({}, common_1.initState);\n\n  if (!skip && !refData.isInit) {\n    if (cacheData && !refData.hasFed && (isSSR || useCache !== false)) {\n      var response = cacheData.response,\n          error = cacheData.error;\n      var action = {\n        type: common_1.ACTIONS.REQUEST_END,\n        response: response,\n        error: error,\n        options: options\n      };\n      debug && console.log('[ReactUseApi][Feed]', cacheKey);\n\n      if (!isSSR) {\n        action.fromCache = true;\n        refData.hasFed = true;\n      }\n\n      defaultState = exports.reducer(defaultState, action);\n    } else if (isSSR) {\n      if (!cacheKeys.has(cacheKey)) {\n        cacheKeys.add(cacheKey);\n        debug && console.log('[ReactUseApi][Collect]', cacheKey);\n      }\n\n      ssrConfigs.push({\n        config: config,\n        cacheKey: cacheKey\n      });\n    }\n  }\n\n  refData.isInit = true;\n\n  var _c = react_1.useReducer(exports.reducer, defaultState),\n      state = _c[0],\n      dispatch = _c[1];\n\n  var shouldRequest = options.shouldRequest,\n      watch = options.watch;\n  var loading = state.loading,\n      data = state.data;\n  var request = react_1.useCallback(function (cfg, keepState, revalidate) {\n    if (cfg === void 0) {\n      cfg = refData.config;\n    }\n\n    if (keepState === void 0) {\n      keepState = false;\n    }\n\n    if (revalidate === void 0) {\n      revalidate = true;\n    }\n\n    return __awaiter(_this, void 0, void 0, function () {\n      var _a, _b;\n\n      return __generator(this, function (_c) {\n        if (options.skip) {\n          return [2\n          /*return*/\n          , null];\n        } // foolproof\n\n\n        if (((_a = cfg) === null || _a === void 0 ? void 0 : _a.target) && ((_b = cfg) === null || _b === void 0 ? void 0 : _b.isDefaultPrevented)) {\n          cfg = refData.config;\n        } // update state's cachekey for saving the prevState when requesting (refreshing)\n        // it's good to set true for pagination\n\n\n        if (keepState) {\n          state.$cacheKey = cacheKey;\n        }\n\n        refData.isRequesting = true;\n        return [2\n        /*return*/\n        , exports.fetchApi(context, cfg, options, dispatch, revalidate)];\n      });\n    });\n  }, [context, cacheKey, options, dispatch, state, refData]);\n  var shouldFetchApi = react_1.useCallback(function (forRerender) {\n    if (forRerender === void 0) {\n      forRerender = false;\n    }\n\n    var shouldRequestResult;\n\n    if (common_1.isFunction(shouldRequest)) {\n      shouldRequestResult = !!shouldRequest();\n    }\n\n    return !skip && !refData.isRequesting && ((forRerender ? shouldRequestResult === true : // false means skip\n    shouldRequestResult !== false) || hasChangedConfig);\n  }, [skip, refData, shouldRequest, hasChangedConfig]); // for each re-rendering\n\n  if (shouldFetchApi(true)) {\n    refData.refreshFlag = Date.now();\n  }\n\n  if (!loading && refData.isRequesting) {\n    refData.isRequesting = false;\n  }\n\n  var useIsomorphicLayoutEffect = isSSR ? react_1.useEffect : react_1.useLayoutEffect;\n  var effect = react_1.useCallback(function (callback) {\n    var args = [];\n\n    for (var _i = 1; _i < arguments.length; _i++) {\n      args[_i - 1] = arguments[_i];\n    }\n\n    var wrapper = function () {\n      if (isValidConfig) {\n        return callback();\n      }\n    };\n\n    return useIsomorphicLayoutEffect.apply(void 0, __spreadArrays([wrapper], args));\n  }, [isValidConfig]);\n  effect(function () {\n    // SSR will never invoke request() due to the following cases:\n    // 1. There is a cacheData for the cacheKey\n    // 2. Feeding the data come from the cache (using defaultState)\n    // 3. Calling API forcibly due to useCache=false\n    // For non-SSR, cacheData will be undefined if cacheKey has been changed\n    if (!isSSR && !refData.hasFed) {\n      request(undefined, undefined, false);\n    }\n  }, __spreadArrays([cacheKey, useCache, refData, refData.refreshFlag], Array.isArray(watch) ? watch : []));\n\n  if (!isValidConfig) {\n    return [undefined, undefined, undefined];\n  }\n\n  return [data, state, request];\n}\n\nexports.useApi = useApi;\n\nexports.reducer = function (state, action) {\n  var type = action.type,\n      options = action.options;\n  var cacheKey = options.$cacheKey;\n  var basicState = {\n    $cacheKey: cacheKey\n  };\n\n  switch (type) {\n    case common_1.ACTIONS.REQUEST_START:\n      {\n        return __assign(__assign(__assign({}, cacheKey !== state.$cacheKey ? common_1.initState : state), {\n          loading: true,\n          error: undefined,\n          fromCache: false\n        }), basicState);\n      }\n\n    case common_1.ACTIONS.REQUEST_END:\n      {\n        var response = action.response,\n            error = action.error,\n            fromCache = action.fromCache;\n\n        var pre = state.prevState,\n            prevState = __rest(state, [\"prevState\"]);\n\n        var prevData = prevState.data;\n        var dependencies = options.dependencies,\n            $hasChangedConfig = options.$hasChangedConfig;\n\n        var newState = __assign(__assign(__assign({}, prevState), {\n          prevData: prevData,\n          prevState: prevState,\n          loading: false,\n          response: response,\n          dependencies: dependencies,\n          error: error,\n          fromCache: !!fromCache\n        }), basicState);\n\n        if ($hasChangedConfig) {\n          delete newState.prevState;\n          delete newState.prevData;\n        }\n\n        newState.data = error ? undefined : common_1.getResponseData(options, newState);\n        return newState;\n      }\n\n    default:\n      return state;\n  }\n};\n\nexports.fetchApi = function (context, config, options, dispatch, revalidate) {\n  if (revalidate === void 0) {\n    revalidate = false;\n  }\n\n  return __awaiter(void 0, void 0, void 0, function () {\n    var cache, cacheKey, useCache, promiseKey, _a, response, error, cacheData, promise, fromCache, err_1;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          cache = context.settings.cache;\n          cacheKey = options.$cacheKey, useCache = options.useCache;\n          promiseKey = cacheKey + \"::promise\";\n          _a = {}, response = _a.response, error = _a.error;\n          _b.label = 1;\n\n        case 1:\n          _b.trys.push([1, 11, 12, 13]);\n\n          cacheData = cache.get(cacheKey);\n          promise = cache.get(promiseKey);\n          response = cacheData === null || cacheData === void 0 ? void 0 : cacheData.response;\n          error = cacheData === null || cacheData === void 0 ? void 0 : cacheData.error;\n          fromCache = !revalidate;\n          if (!revalidate) return [3\n          /*break*/\n          , 3];\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_START,\n            options: options\n          });\n          return [4\n          /*yield*/\n          , common_1.axiosAll(context, config)];\n\n        case 2:\n          response = _b.sent();\n          return [3\n          /*break*/\n          , 10];\n\n        case 3:\n          if (!(useCache !== false && promise)) return [3\n          /*break*/\n          , 5];\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_START,\n            options: options\n          });\n          return [4\n          /*yield*/\n          , promise];\n\n        case 4:\n          response = _b.sent();\n          return [3\n          /*break*/\n          , 10];\n\n        case 5:\n          if (!(useCache !== false && (response || error))) return [3\n          /*break*/\n          , 6];\n          return [3\n          /*break*/\n          , 10];\n\n        case 6:\n          if (!useCache) return [3\n          /*break*/\n          , 8];\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_START,\n            options: options\n          });\n          promise = common_1.axiosAll(context, config); // save promise for next coming hooks\n\n          cache.set(promiseKey, promise);\n          return [4\n          /*yield*/\n          , promise];\n\n        case 7:\n          response = _b.sent();\n          return [3\n          /*break*/\n          , 10];\n\n        case 8:\n          fromCache = false;\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_START,\n            options: options\n          });\n          return [4\n          /*yield*/\n          , common_1.axiosAll(context, config)];\n\n        case 9:\n          response = _b.sent();\n          _b.label = 10;\n\n        case 10:\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_END,\n            response: response,\n            error: error,\n            options: options,\n            fromCache: fromCache\n          });\n          return [3\n          /*break*/\n          , 13];\n\n        case 11:\n          err_1 = _b.sent();\n          error = err_1;\n          dispatch({\n            type: common_1.ACTIONS.REQUEST_END,\n            error: error,\n            options: options\n          });\n          return [3\n          /*break*/\n          , 13];\n\n        case 12:\n          // save the data if there is no cache data come from server\n          if (useCache) {\n            if (!cache.has(cacheKey)) {\n              cache.set(cacheKey, {\n                response: response,\n                error: error\n              });\n            }\n\n            if (cache.has(promiseKey)) {\n              cache.del(promiseKey);\n            }\n          }\n\n          return [7\n          /*endfinally*/\n          ];\n\n        case 13:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n};\n\nexports.handleUseApiOptions = function (opt, settings, config, cacheKey) {\n  var options = common_1.isObject(opt) ? __assign({}, opt) : {\n    watch: Array.isArray(opt) ? opt : [],\n    handleData: common_1.isFunction(opt) ? opt : undefined\n  };\n  options.$cacheKey = cacheKey;\n  var alwaysUseCache = settings.alwaysUseCache,\n      shouldUseApiCache = settings.shouldUseApiCache;\n  var globalUseCache = shouldUseApiCache(config, cacheKey) !== false;\n\n  if (alwaysUseCache) {\n    options.useCache = true;\n  } else if (globalUseCache === false) {\n    options.useCache = false;\n  }\n\n  return options;\n};\n\nexports.verifyConfig = function (config) {\n  return common_1.isObject(config) ? !!config.url : Array.isArray(config) ? config.every(function (each) {\n    return !!each.url;\n  }) : false;\n};\n\nexports.default = useApi;","map":{"version":3,"sources":["../src/useApi.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n            r[k] = a[j];\n    return r;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.verifyConfig = exports.handleUseApiOptions = exports.fetchApi = exports.reducer = exports.useApi = void 0;\nvar react_1 = require(\"react\");\nvar context_1 = require(\"./context\");\nvar common_1 = require(\"./common\");\nfunction useApi(config, opt) {\n    var _this = this;\n    if (typeof config === 'string') {\n        config = {\n            url: config,\n        };\n    }\n    var context = react_1.useContext(context_1.ApiContext);\n    var settings = context.settings, _a = context.settings, cache = _a.cache, debug = _a.debug, clearLastCacheWhenConfigChanges = _a.clearLastCacheWhenConfigChanges, isSSR = context.isSSR, _b = context.collection, ssrConfigs = _b.ssrConfigs, cacheKeys = _b.cacheKeys;\n    var cacheKey = JSON.stringify(config);\n    var ref = react_1.useRef(react_1.useMemo(function () {\n        return ({\n            id: Date.now(),\n            isRequesting: false,\n            isInit: false,\n            hasFed: false,\n            refreshFlag: 1,\n            cacheKey: cacheKey,\n            config: config,\n        });\n    }, []));\n    var options = react_1.useMemo(function () { return exports.handleUseApiOptions(opt, settings, config, cacheKey); }, [opt, settings, cacheKey]);\n    var refData = ref.current;\n    var isValidConfig = exports.verifyConfig(config);\n    var hasChangedConfig = refData.cacheKey !== cacheKey;\n    options.$hasChangedConfig = hasChangedConfig;\n    if (hasChangedConfig) {\n        if (clearLastCacheWhenConfigChanges) {\n            cache.del(refData.cacheKey);\n        }\n        refData.cacheKey = cacheKey;\n        refData.config = config;\n        refData.hasFed = false;\n    }\n    // SSR processing\n    var cacheData = cache.get(cacheKey);\n    var skip = options.skip, useCache = options.useCache;\n    var defaultState = __assign({}, common_1.initState);\n    if (!skip && !refData.isInit) {\n        if (cacheData && !refData.hasFed && (isSSR || useCache !== false)) {\n            var response = cacheData.response, error = cacheData.error;\n            var action = {\n                type: common_1.ACTIONS.REQUEST_END,\n                response: response,\n                error: error,\n                options: options,\n            };\n            debug && console.log('[ReactUseApi][Feed]', cacheKey);\n            if (!isSSR) {\n                action.fromCache = true;\n                refData.hasFed = true;\n            }\n            defaultState = exports.reducer(defaultState, action);\n        }\n        else if (isSSR) {\n            if (!cacheKeys.has(cacheKey)) {\n                cacheKeys.add(cacheKey);\n                debug && console.log('[ReactUseApi][Collect]', cacheKey);\n            }\n            ssrConfigs.push({\n                config: config,\n                cacheKey: cacheKey,\n            });\n        }\n    }\n    refData.isInit = true;\n    var _c = react_1.useReducer(exports.reducer, defaultState), state = _c[0], dispatch = _c[1];\n    var shouldRequest = options.shouldRequest, watch = options.watch;\n    var loading = state.loading, data = state.data;\n    var request = react_1.useCallback(function (cfg, keepState, revalidate) {\n        if (cfg === void 0) { cfg = refData.config; }\n        if (keepState === void 0) { keepState = false; }\n        if (revalidate === void 0) { revalidate = true; }\n        return __awaiter(_this, void 0, void 0, function () {\n            var _a, _b;\n            return __generator(this, function (_c) {\n                if (options.skip) {\n                    return [2 /*return*/, null];\n                }\n                // foolproof\n                if (((_a = cfg) === null || _a === void 0 ? void 0 : _a.target) && ((_b = cfg) === null || _b === void 0 ? void 0 : _b.isDefaultPrevented)) {\n                    cfg = refData.config;\n                }\n                // update state's cachekey for saving the prevState when requesting (refreshing)\n                // it's good to set true for pagination\n                if (keepState) {\n                    state.$cacheKey = cacheKey;\n                }\n                refData.isRequesting = true;\n                return [2 /*return*/, exports.fetchApi(context, cfg, options, dispatch, revalidate)];\n            });\n        });\n    }, [context, cacheKey, options, dispatch, state, refData]);\n    var shouldFetchApi = react_1.useCallback(function (forRerender) {\n        if (forRerender === void 0) { forRerender = false; }\n        var shouldRequestResult;\n        if (common_1.isFunction(shouldRequest)) {\n            shouldRequestResult = !!shouldRequest();\n        }\n        return (!skip &&\n            !refData.isRequesting &&\n            ((forRerender\n                ? shouldRequestResult === true\n                : // false means skip\n                    shouldRequestResult !== false) ||\n                hasChangedConfig));\n    }, [skip, refData, shouldRequest, hasChangedConfig]);\n    // for each re-rendering\n    if (shouldFetchApi(true)) {\n        refData.refreshFlag = Date.now();\n    }\n    if (!loading && refData.isRequesting) {\n        refData.isRequesting = false;\n    }\n    var useIsomorphicLayoutEffect = isSSR ? react_1.useEffect : react_1.useLayoutEffect;\n    var effect = react_1.useCallback(function (callback) {\n        var args = [];\n        for (var _i = 1; _i < arguments.length; _i++) {\n            args[_i - 1] = arguments[_i];\n        }\n        var wrapper = function () {\n            if (isValidConfig) {\n                return callback();\n            }\n        };\n        return useIsomorphicLayoutEffect.apply(void 0, __spreadArrays([wrapper], args));\n    }, [isValidConfig]);\n    effect(function () {\n        // SSR will never invoke request() due to the following cases:\n        // 1. There is a cacheData for the cacheKey\n        // 2. Feeding the data come from the cache (using defaultState)\n        // 3. Calling API forcibly due to useCache=false\n        // For non-SSR, cacheData will be undefined if cacheKey has been changed\n        if (!isSSR && !refData.hasFed) {\n            request(undefined, undefined, false);\n        }\n    }, __spreadArrays([\n        cacheKey,\n        useCache,\n        refData,\n        refData.refreshFlag\n    ], (Array.isArray(watch) ? watch : [])));\n    if (!isValidConfig) {\n        return [undefined, undefined, undefined];\n    }\n    return [data, state, request];\n}\nexports.useApi = useApi;\nexports.reducer = function (state, action) {\n    var type = action.type, options = action.options;\n    var cacheKey = options.$cacheKey;\n    var basicState = {\n        $cacheKey: cacheKey,\n    };\n    switch (type) {\n        case common_1.ACTIONS.REQUEST_START: {\n            return __assign(__assign(__assign({}, (cacheKey !== state.$cacheKey ? common_1.initState : state)), { loading: true, error: undefined, fromCache: false }), basicState);\n        }\n        case common_1.ACTIONS.REQUEST_END: {\n            var response = action.response, error = action.error, fromCache = action.fromCache;\n            var pre = state.prevState, prevState = __rest(state, [\"prevState\"]);\n            var prevData = prevState.data;\n            var dependencies = options.dependencies, $hasChangedConfig = options.$hasChangedConfig;\n            var newState = __assign(__assign(__assign({}, prevState), { prevData: prevData,\n                prevState: prevState, loading: false, response: response,\n                dependencies: dependencies,\n                error: error, fromCache: !!fromCache }), basicState);\n            if ($hasChangedConfig) {\n                delete newState.prevState;\n                delete newState.prevData;\n            }\n            newState.data = error ? undefined : common_1.getResponseData(options, newState);\n            return newState;\n        }\n        default:\n            return state;\n    }\n};\nexports.fetchApi = function (context, config, options, dispatch, revalidate) {\n    if (revalidate === void 0) { revalidate = false; }\n    return __awaiter(void 0, void 0, void 0, function () {\n        var cache, cacheKey, useCache, promiseKey, _a, response, error, cacheData, promise, fromCache, err_1;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    cache = context.settings.cache;\n                    cacheKey = options.$cacheKey, useCache = options.useCache;\n                    promiseKey = cacheKey + \"::promise\";\n                    _a = {}, response = _a.response, error = _a.error;\n                    _b.label = 1;\n                case 1:\n                    _b.trys.push([1, 11, 12, 13]);\n                    cacheData = cache.get(cacheKey);\n                    promise = cache.get(promiseKey);\n                    response = cacheData === null || cacheData === void 0 ? void 0 : cacheData.response;\n                    error = cacheData === null || cacheData === void 0 ? void 0 : cacheData.error;\n                    fromCache = !revalidate;\n                    if (!revalidate) return [3 /*break*/, 3];\n                    dispatch({ type: common_1.ACTIONS.REQUEST_START, options: options });\n                    return [4 /*yield*/, common_1.axiosAll(context, config)];\n                case 2:\n                    response = _b.sent();\n                    return [3 /*break*/, 10];\n                case 3:\n                    if (!(useCache !== false && promise)) return [3 /*break*/, 5];\n                    dispatch({ type: common_1.ACTIONS.REQUEST_START, options: options });\n                    return [4 /*yield*/, promise];\n                case 4:\n                    response = _b.sent();\n                    return [3 /*break*/, 10];\n                case 5:\n                    if (!(useCache !== false && (response || error))) return [3 /*break*/, 6];\n                    return [3 /*break*/, 10];\n                case 6:\n                    if (!useCache) return [3 /*break*/, 8];\n                    dispatch({ type: common_1.ACTIONS.REQUEST_START, options: options });\n                    promise = common_1.axiosAll(context, config);\n                    // save promise for next coming hooks\n                    cache.set(promiseKey, promise);\n                    return [4 /*yield*/, promise];\n                case 7:\n                    response = _b.sent();\n                    return [3 /*break*/, 10];\n                case 8:\n                    fromCache = false;\n                    dispatch({ type: common_1.ACTIONS.REQUEST_START, options: options });\n                    return [4 /*yield*/, common_1.axiosAll(context, config)];\n                case 9:\n                    response = _b.sent();\n                    _b.label = 10;\n                case 10:\n                    dispatch({ type: common_1.ACTIONS.REQUEST_END, response: response, error: error, options: options, fromCache: fromCache });\n                    return [3 /*break*/, 13];\n                case 11:\n                    err_1 = _b.sent();\n                    error = err_1;\n                    dispatch({\n                        type: common_1.ACTIONS.REQUEST_END,\n                        error: error,\n                        options: options,\n                    });\n                    return [3 /*break*/, 13];\n                case 12:\n                    // save the data if there is no cache data come from server\n                    if (useCache) {\n                        if (!cache.has(cacheKey)) {\n                            cache.set(cacheKey, {\n                                response: response,\n                                error: error,\n                            });\n                        }\n                        if (cache.has(promiseKey)) {\n                            cache.del(promiseKey);\n                        }\n                    }\n                    return [7 /*endfinally*/];\n                case 13: return [2 /*return*/];\n            }\n        });\n    });\n};\nexports.handleUseApiOptions = function (opt, settings, config, cacheKey) {\n    var options = common_1.isObject(opt)\n        ? __assign({}, opt)\n        : {\n            watch: Array.isArray(opt) ? opt : [],\n            handleData: common_1.isFunction(opt) ? opt : undefined,\n        };\n    options.$cacheKey = cacheKey;\n    var alwaysUseCache = settings.alwaysUseCache, shouldUseApiCache = settings.shouldUseApiCache;\n    var globalUseCache = shouldUseApiCache(config, cacheKey) !== false;\n    if (alwaysUseCache) {\n        options.useCache = true;\n    }\n    else if (globalUseCache === false) {\n        options.useCache = false;\n    }\n    return options;\n};\nexports.verifyConfig = function (config) {\n    return common_1.isObject(config)\n        ? !!config.url\n        : Array.isArray(config)\n            ? config.every(function (each) { return !!each.url; })\n            : false;\n};\nexports.default = useApi;\n//# sourceMappingURL=useApi.js.map"]},"metadata":{},"sourceType":"script"}